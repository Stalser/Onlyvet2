# Интеграция OnlyVet ↔ Vetmanager

Этот документ описывает архитектуру и основные потоки интеграции онлайн-сервиса **OnlyVet** с ветеринарной CRM/PMS **Vetmanager**.

## 1. Роли и участники

- **Клиент (владелец)** — записывается онлайн, получает консультации, видит историю и инструкции.
- **Врач (сотрудник)** — работает в портале врача OnlyVet, часть данных синхронизируется с Vetmanager.
- **Администратор** — управляет врачами и интеграцией Vetmanager.
- **Vetmanager** — основная база клиники: пациенты, владельцы, врачи, приёмы, услуги, финансы.

## 2. Архитектура взаимодействия

```text
Клиент / Врач / Админ
        │
        ▼
OnlyVet (Next.js + API routes)
        │
        ▼
Vetmanager API (REST / GraphQL, токен)
```

Браузер никогда не обращается напрямую к Vetmanager — только через backend OnlyVet.

## 3. Авторизация и роли

### 3.1 Клиент
- Входит через `/auth/login` (вкладка «Клиент»).
- E-mail → код → `/account`.

### 3.2 Врач
- Входит через `/auth/login` (вкладка «Сотрудник») или `/auth/doctor`.
- E-mail проверяется по списку разрешённых врачей (управляет админ).
- Кука `ov_doc` открывает доступ к `/doctor/*` (middleware).

### 3.3 Админ
- Входит через `/auth/admin` → `ov_admin`.
- Имеет доступ к `/admin/*` (управление врачами, Vetmanager).

## 4. Управление врачами (только админ)

- Список врачей хранится в `doctorStore` или БД.
- `GET/POST/DELETE /api/admin/doctors` — управляют списком.
- UI `/admin/doctors`:
  - ручное добавление врача;
  - импорт врачей из Vetmanager.

## 5. Vetmanager: обёртка и эндпоинты

Файл `lib/vetmanager.ts`:

- `vmFetch(path, init)` — общий вызов Vetmanager API.
- `vmPing()` — проверка настроек и доступности.
- `vmListDoctors()` — загрузка списка врачей.
- `vmListSchedule(doctorId)` — загрузка расписания врача.
- `vmRequest` и `pushToVetmanager` — совместимость со старыми API.

## 6. Потоки данных

### 6.1 Импорт врачей

1. Админ нажимает «Загрузить врачей из Vetmanager».
2. `POST /api/admin/doctors/import-from-vetmanager`:
   - вызывает `vmListDoctors()`;
   - переносит e-mail и ФИО в список разрешённых врачей.

### 6.2 Онлайн-запись клиента

1. Клиент заполняет форму записи (услуга, врач, время, данные питомца).
2. `POST /api/booking`:
   - сохраняет запись локально;
   - вызывает `pushToVetmanager(payload)`:
     - создаёт/обновляет владельца;
     - создаёт/обновляет пациента;
     - создаёт appointment с пометкой OnlyVet/ONLINE.

### 6.3 Работа врача

1. Врач входит как «Сотрудник» → `/doctor/*`.
2. В `/doctor/appointments` может быть показано расписание:
   - либо из локальных моков;
   - либо из `GET /api/vetmanager/schedule?doctorId=...`.
3. В `/doctor/appointment/[id]` врач видит:
   - данные записи и пациента;
   - заметки врача;
   - файлы клиента;
   - статус (запланирован/завершён/отменён);
   - быстрые действия (видео, чат, экспорт PDF).

## 7. Дополнительные шаги интеграции

- Подключить реальные эндпоинты Vetmanager для клиентов, пациентов и приёмов.
- Связать ID врача в OnlyVet с ID врача в Vetmanager.
- Сохранять заметки врача в историю посещений Vetmanager.
- Реализовать двустороннюю синхронизацию статусов приёмов.

